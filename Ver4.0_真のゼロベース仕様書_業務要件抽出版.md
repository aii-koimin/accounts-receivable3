# 🎯 Ver4.0 真のゼロベース仕様書 - 売掛金管理AIエージェントシステム

## 📋 **設計原理: ソースコード完全不要の純粋業務仕様書**

**本仕様書の特徴:**
- ✅ 実装コード参照一切不要
- ✅ 業務要件から直接システム生成可能
- ✅ 研究観点（AI自律処理・心理的負担軽減）重視
- ✅ 再利用可能・拡張可能な設計

---

# 📄 **SECTION 1: 業務要件定義書**

## 1.1 ビジネス課題・研究目的

### 🚨 **現状の業務課題**
**課題1: 処理時間の長期化**
- 売掛金差異（未入金・過入金）の対応が手動処理中心
- 1件あたり平均2-3日、複雑ケースでは2週間以上を要する
- 月末処理時に大量発生し、業務がボトルネック化

**課題2: 担当者の心理的負担**
- 差異発生時の顧客対応における精神的ストレス
- 進捗が見えない不安感（「いつ終わるか分からない」状態）
- 対応漏れ・遅延に対する責任感とプレッシャー

**課題3: 業務品質の属人化**
- 経験豊富な担当者とそうでない担当者の対応品質格差
- 顧客コミュニケーションの一貫性不足
- ナレッジ共有・標準化の困難

### 🎯 **解決目標（研究仮説の実証）**
**目標1: AI自律処理70%達成**
- 定型的な差異処理をAIが自動実行
- 人間は複雑ケース・例外処理に専念
- 効果測定: 自動処理率70%以上を実現

**目標2: 心理的負担30%軽減**
- 5ステップ進捗表示による「見える化」効果
- 推定完了時間表示による不安軽減
- 効果測定: 担当者アンケート・ストレス指標で30%改善

**目標3: 処理時間80%短縮**
- 従来2週間 → 目標2日以内
- 自動化による大幅時間短縮
- 効果測定: 平均処理時間の定量比較

### 📊 **成功指標（研究価値の定量測定）**
```
【定量指標】
- AI自律処理率: 70%以上
- 平均処理時間: 2日以内（従来14日→80%短縮）
- 人間作業時間: 30%以下（残り70%をAI処理）

【定性指標】
- 担当者心理的負担: 30%軽減（アンケート調査）
- 顧客満足度: 20%向上（対応スピード改善）
- 処理品質一貫性: 90%以上（標準化効果）
```

## 1.2 ステークホルダー・利用者

### 👥 **主要利用者**
**利用者1: 経理担当者（メインユーザー）**
- 役割: 日常的な差異処理・顧客対応実行
- 利用頻度: 日次（月末は集中的）
- 期待効果: 作業負荷軽減・ストレス軽減

**利用者2: 経理管理者（スーパーバイザー）**
- 役割: 進捗監視・エスカレーション対応・品質管理
- 利用頻度: 週次レビュー・問題発生時
- 期待効果: 管理効率向上・品質安定化

**利用者3: 顧客（間接利用者）**
- 役割: メール受信・問い合わせ回答
- 利用頻度: 差異発生時のみ
- 期待効果: 迅速・丁寧な対応受領

### 🎬 **利用シーン**
**シーン1: 月末締め処理時**
- タイミング: 毎月末日〜翌月5日
- 状況: 大量の差異データが一斉発生
- 要求: 迅速・正確な一括処理

**シーン2: 日常差異発生時**
- タイミング: 随時（入金確認時）
- 状況: 個別の差異発見・対応
- 要求: 即座の判定・適切な初期対応

**シーン3: 顧客問い合わせ対応時**
- タイミング: 顧客からの連絡受信時
- 状況: 差異に関する説明・調整依頼
- 要求: 迅速・正確な情報提供・解決策提示

## 1.3 業務フロー（現状 vs 理想）

### ❌ **現状フロー（手動中心・非効率）**
```
Step1: 差異発見（手動確認）
├ 請求データと入金データを目視照合 [2-3時間]
├ 差異リストを手動作成 [1時間]
└ 優先度を経験で判断 [1時間]

Step2: 顧客対応準備（個別作成）
├ 顧客情報・過去履歴を手動調査 [30分/件]
├ 個別メール文面を手動作成 [20分/件]
└ 上司承認・確認 [待機時間含め半日]

Step3: 顧客連絡・フォローアップ（属人的）
├ メール送信・電話対応 [10分/件]
├ 返信待ち・進捗不明 [数日〜数週間]
└ フォローアップ忘れ・遅延リスク

Step4: 解決・記録（手動更新）
├ 解決内容の手動記録 [15分/件]
├ 関連システム更新 [10分/件]
└ 次回対応用メモ作成 [5分/件]

【問題点】
- 全工程が手動・属人的
- 進捗が見えず不安感大
- 処理漏れ・遅延が頻発
- 品質が担当者依存
```

### ✅ **理想フロー（AI自律処理中心・効率化）**
```
Step1: AI自動差異検知 [5分]
├ システムが自動照合・差異抽出
├ AI確信度計算・リスク評価
└ 介入レベル自動判定（ai_autonomous/ai_assisted/human_required）

Step2: AI自動対応実行 [自動]
├ 【ai_autonomous】自動メール生成・送信
├ 【ai_assisted】メール下書き作成→人間承認
└ 【human_required】担当者アサイン・アラート

Step3: 5ステップ進捗管理 [リアルタイム可視化]
├ 検知→メール送付→連絡取得→合意→解決
├ 各ステップ進捗率・推定完了時間表示
└ 自動エスカレーション・リマインダー

Step4: 自動記録・学習 [自動]
├ 全対応履歴の自動記録
├ AI学習データとして蓄積
└ 次回対応精度向上

【改善効果】
- 70%処理を完全自動化
- 進捗完全可視化→心理的負担軽減
- 品質標準化・一貫性確保
- 処理時間2週間→2日短縮
```

---

# 📋 **SECTION 2: 機能仕様書**

## 2.1 システム機能一覧

### 🤖 **機能1: AI自動差異検知システム**
**概要**: 請求・入金データを自動照合し、差異を検知・分類
**入力**: 請求データ（invoices）、入金データ（payments）
**出力**: 差異レコード（type: unpaid/overpaid/partial/multiple_invoices）
**処理ロジック**:
```
1. データ照合アルゴリズム実行
2. 差異パターン分類（4種類）
3. 確信度計算（0.0-1.0）
4. 顧客リスクレベル評価
5. 優先度自動判定（low/medium/high/urgent）
```

### 👤 **機能1-2: ユーザー認証・権限管理システム**
**概要**: JWT認証によるセキュアなユーザー管理
**機能**:
```
- ユーザー登録: 名前・メール・パスワード・役割設定
- ログイン認証: JWT トークン発行（7日間有効）
- プロフィール管理: ユーザー情報表示・更新
- パスワード変更: 現在パスワード確認・新パスワード設定
- 役割ベース制御: ADMIN/MANAGER/USER権限管理
- セッション管理: 自動ログアウト・トークン更新
```

### 🏢 **機能1-3: 顧客管理システム**
**概要**: 顧客マスタの完全CRUD操作・検索
**機能**:
```
- 顧客作成: 基本情報・支払条件・信用限度額設定
- 顧客一覧: ページング・ソート・検索機能
- 顧客詳細: 取引履歴・請求書・入金履歴表示
- 顧客更新: 情報変更・リスクレベル調整
- リスク評価: LOW/MEDIUM/HIGH/CRITICAL自動判定
- 検索機能: 顧客名・コード・メールアドレス対応
```

### 📋 **機能1-4: タスク管理システム**
**概要**: AI処理タスクの自動生成・進捗管理
**機能**:
```
- タスク自動生成: 差異検知時の自動タスク作成
- タスク一覧: フィルタ・ソート・ページング
- タスク割り当て: ユーザーへの自動・手動割り当て
- 進捗追跡: PENDING/PROCESSING/COMPLETED/FAILED
- 優先度管理: LOW/MEDIUM/HIGH/URGENT
- 完了通知: タスク完了時の自動通知
```

### 🔔 **機能1-5: 通知・アクティビティログシステム**
**概要**: システム操作の完全追跡・通知配信
**機能**:
```
- アクティビティログ: 全操作の詳細記録
- 通知配信: 重要イベントの即座通知
- 操作履歴: 変更前後値の完全保存
- 監査証跡: コンプライアンス対応
- IPアドレス記録: セキュリティ監視
- ユーザーエージェント記録: アクセス詳細
```

### 📊 **機能2: 5ステップ進捗管理システム**
**概要**: 差異解決までの進捗を5段階で可視化・管理
**5ステップ定義**:
```
Step1 [検知] 20%: AI差異検知完了
Step2 [メール送付] 40%: 顧客へ連絡送信完了
Step3 [連絡取得] 60%: 顧客から返信受信
Step4 [合意] 80%: 解決方法合意成立
Step5 [解決] 100%: 完全解決・記録完了
```
**表示要素**:
- 進捗バー（0-100%）
- 現在ステップのハイライト表示
- 推定完了時間
- 次アクション提示

### 🎯 **機能3: AI自動メール生成・送信システム**
**概要**: 差異内容・顧客特性に応じて最適なメールを自動生成・送信
**生成条件**:
```
- 確信度70%以上
- 顧客リスクレベル: LOW/MEDIUM
- 差異金額: 標準範囲内
- 過去対応履歴: 良好
```
**メールテンプレート種類**:
- 未入金督促メール（1次・2次・最終）
- 過入金照会メール
- 一部入金確認メール
- 複数請求統合メール

### 📈 **機能4: 3段階AI介入レベル判定システム**
**概要**: 確信度・リスク・複雑さに基づく自動処理レベル判定

**ai_autonomous（自動処理）**: 確信度90%以上
```
- 条件: 単純差異 + 低リスク顧客 + 小額差異
- 処理: 完全自動対応（メール送信→ステータス更新）
- 人間介入: 不要（結果報告のみ）
```

**ai_assisted（AI支援）**: 確信度70-89%
```
- 条件: 中程度複雑差異 + 中リスク顧客
- 処理: AI下書き作成→人間承認→送信
- 人間介入: 承認・微調整のみ
```

**human_required（人間必須）**: 確信度70%未満
```
- 条件: 複雑差異 + 高リスク顧客 + 大額差異
- 処理: 完全手動対応
- 人間介入: 全工程で必要
```

## 2.2 AI処理ルール・アルゴリズム

### 🧠 **確信度計算ロジック**
```
基本確信度 = 0.5

【金額差異による調整】
- 1万円未満: +0.2
- 1-10万円: +0.1
- 10-50万円: 0.0
- 50万円以上: -0.2

【顧客リスクレベルによる調整】
- LOW: +0.2
- MEDIUM: +0.1
- HIGH: -0.1
- CRITICAL: -0.3

【過去履歴による調整】
- 良好な支払履歴: +0.1
- 過去トラブル歴: -0.1
- 初回取引: 0.0

最終確信度 = min(0.99, max(0.1, 基本確信度 + 各調整値))
```

### ⏰ **自動エスカレーション条件**
```
【時間ベースエスカレーション】
- ai_autonomous: 3日経過で ai_assisted にエスカレーション
- ai_assisted: 7日経過で human_required にエスカレーション
- human_required: 14日経過で管理者アラート

【状況ベースエスカレーション】
- 顧客からクレーム: 即座に human_required
- 金額変更要求: ai_assisted 以上
- 法的問題示唆: 即座に管理者エスカレーション
```

## 2.3 業務ルール・制約条件

### 📋 **必須業務ルール**
**時間制約**:
- メール送信: 営業時間内のみ（9:00-18:00、土日祝除く）
- 自動処理: 24時間実行可能
- エスカレーション: 営業時間内に実行

**金額制約**:
- 自動処理上限: 50万円まで
- AI支援上限: 200万円まで
- 人間必須: 200万円超 または 法人月額取引の30%超

**顧客対応制約**:
- 同一差異への連絡: 72時間間隔必須
- 督促メール: 最大3回まで
- 電話対応必要: 3回メール無応答時

### 🔒 **データ保護・監査要件**
**個人情報保護**:
- 顧客情報暗号化保存必須
- アクセスログ完全記録
- 不要データ自動削除（5年経過後）

**監査証跡**:
- 全AI判定根拠記録保持
- 人間による承認・変更履歴
- メール送信ログ・顧客応答記録

---

# 📊 **SECTION 3: データ仕様書**

## 3.1 主要エンティティ定義

### 🏢 **顧客（Customer）**
```
- 顧客ID: 一意識別子（cuid形式）
- 顧客コード: 業務用コード（例: CUST001）
- 顧客名: 会社名/個人名（必須）
- メールアドレス: 連絡先（必須）
- 電話番号: 連絡先（オプション）
- 住所: 請求先住所（オプション）
- 担当者名: 窓口担当者（オプション）
- 支払条件: 支払期限日数（デフォルト30日）
- 信用限度額: 取引上限金額（オプション）
- リスクレベル: LOW/MEDIUM/HIGH/CRITICAL（デフォルトLOW）
- 有効フラグ: アクティブ顧客判定
- 備考: 特記事項（オプション）
- 作成日時・更新日時・作成者ID
```

### 💰 **入金差異（PaymentDiscrepancy）**
```
- 差異ID: 一意識別子（cuid形式）
- 顧客ID: 対象顧客への外部キー（必須）
- 差異タイプ: unpaid/overpaid/partial/multiple_invoices（必須）
- ステータス: detected/processing/email_sent/customer_contacted/resolved
- 優先度: low/medium/high/urgent（デフォルトmedium）
- 介入レベル: ai_autonomous/ai_assisted/human_required
- 予定金額: 本来入金されるべき金額（必須）
- 実際金額: 実際に入金された金額（必須）
- 差異金額: 予定金額 - 実際金額（計算値）
- 検知日時: 差異発見日時
- 期限日: 支払期限日（オプション）
- 期限超過日数: 計算値（オプション）
- 担当者ID: 割り当て担当者（オプション）
- 割当日時: 担当者アサイン日時（オプション）
- 備考: 対応メモ（オプション）
- タグ: 分類用タグ（JSON配列）
- AI分析結果: 推奨アクション・確信度・理由（JSON形式）
- Excel取り込みキー: 重複防止用キー（importKey）
- 作成日時・更新日時
```

### 👤 **ユーザー（User）**
```
- ユーザーID: 一意識別子（cuid形式）
- メールアドレス: ログイン用メール（一意）
- パスワード: ハッシュ化パスワード
- 名前: 表示用名前
- 役割: ADMIN/MANAGER/USER
- 有効フラグ: アカウント有効無効
- 作成日時・更新日時
```

### 📋 **タスク（Task）**
```
- タスクID: 一意識別子（cuid形式）
- タイプ: UNPAID_DETECTION/PAYMENT_MATCHING/RISK_ASSESSMENT等
- タイトル: タスクタイトル
- 説明: タスク詳細説明
- 優先度: LOW/MEDIUM/HIGH/URGENT
- ステータス: PENDING/PROCESSING/COMPLETED/FAILED/CANCELLED
- 担当者ID: 割り当てユーザー
- 期限日: タスク期限
- 完了日時: 完了時刻
- 結果: 実行結果（JSON形式）
- メタデータ: 追加情報（JSON形式）
- 作成日時・更新日時
```

### 🔔 **通知（Notification）**
```
- 通知ID: 一意識別子（cuid形式）
- ユーザーID: 通知対象ユーザー
- タイプ: INVOICE_OVERDUE/PAYMENT_RECEIVED/RISK_ALERT等
- タイトル: 通知タイトル
- メッセージ: 通知内容
- データ: 関連データ（JSON形式）
- 既読フラグ: 既読未読状態
- 既読日時: 既読確認日時
- 作成日時
```

### 📊 **リスク評価（RiskAssessment）**
```
- 評価ID: 一意識別子（cuid形式）
- 顧客ID: 評価対象顧客
- リスクスコア: 0.0-1.0のスコア
- リスクレベル: LOW/MEDIUM/HIGH/CRITICAL
- 評価要因: 判定要因（JSON形式）
- 評価コメント: 詳細コメント
- 有効期限: 評価の有効期限
- 作成日時
```

### 🤖 **AI予測（AiPrediction）**
```
- 予測ID: 一意識別子（cuid形式）
- 請求書ID: 予測対象請求書
- 予測タイプ: PAYMENT_DATE/RISK_SCORE/COLLECTION_SUCCESS_RATE
- 予測結果: 予測内容（JSON形式）
- 信頼度: 0.0-1.0の信頼度
- 有効期限: 予測の有効期限
- 作成日時
```

### 📧 **メール送信ログ（EmailLog）**
```
- ログID: 一意識別子（cuid形式）
- 差異ID: 対象差異への外部キー（オプション）
- 顧客ID: 送信先顧客への外部キー（オプション）
- 送信者: システム送信者情報（必須）
- 宛先: 顧客メールアドレス（必須）
- 件名: メール件名（必須）
- 本文: メール本文（必須）
- テンプレートID: 使用テンプレート識別子（オプション）
- 送信状態: pending/sent/failed/delivered/bounced
- 送信日時: 送信実行日時（オプション）
- 配信日時: 配信確認日時（オプション）
- エラー内容: 送信失敗時の詳細（オプション）
- 作成日時・更新日時
```

### ⚙️ **システム設定（SystemConfig）**
```
- 設定ID: 一意識別子（cuid形式）
- キー: 設定項目名（smtp_host, smtp_port, smtp_user等）
- 値: 設定値（文字列形式）
- カテゴリー: smtp/email/security/app等
- 有効フラグ: 設定の有効無効
- 説明: 設定項目の説明
- 作成日時・更新日時
```

### 📧 **メールテンプレート（EmailTemplate）**
```
- テンプレートID: 一意識別子（cuid形式）
- テンプレート名: 表示用名称
- 件名: メール件名テンプレート
- 本文: メール本文テンプレート（HTML対応）
- タイプ: unpaid_reminder/overpaid_inquiry/payment_confirmation等
- ステージ: reminder/second_reminder/final/inquiry等
- 変数リスト: 使用可能な変数（JSON配列）
- 有効フラグ: テンプレートの有効無効
- 作成者ID: テンプレート作成ユーザー
- 作成日時・更新日時
```

### 📝 **アクティビティログ（ActivityLog）**
```
- ログID: 一意識別子（cuid形式）
- ユーザーID: 操作実行ユーザー
- アクション: 操作種別（create/update/delete/email_send/file_upload等）
- エンティティタイプ: 操作対象テーブル名
- エンティティID: 操作対象レコードID（オプション）
- 変更前値: 更新前の値（JSON形式）
- 変更後値: 更新後の値（JSON形式）
- IPアドレス: 操作元IPアドレス
- ユーザーエージェント: ブラウザ情報
- 実行日時: 操作実行日時
```

## 3.2 データ関係（リレーション）

### 🔗 **主要リレーション**
```
顧客（Customer） 1:N 入金差異（PaymentDiscrepancy）
- 1人の顧客に対し複数の差異が発生可能
- 差異は必ず1人の顧客に紐づく
- 削除時: 顧客削除で関連差異も削除（CASCADE）

入金差異（PaymentDiscrepancy） 1:N メール送信ログ（EmailLog）
- 1つの差異に対し複数のメール送信可能
- メール送信は差異に関連する場合が多い
- 削除時: 差異削除で関連メールログも削除（CASCADE）

顧客（Customer） 1:N メール送信ログ（EmailLog）
- 1人の顧客に対し複数のメール送信可能
- 差異以外のメール送信も記録
- 削除時: 顧客削除で関連メールログも削除（CASCADE）
```

## 3.3 外部データ連携仕様

### 📋 **Excel取り込みデータフォーマット**
**必須フィールド**:
```
- 分類: 差異タイプ（"未入金"/"過入金"/"一部入金"/"複数請求"）
- 会社名: 顧客名（完全一致 or 新規作成）
- 金額: 差異金額（数値形式）
- to: 顧客メールアドレス（メール形式）
```

**オプションフィールド**:
```
- 決済期日: 支払期限（日付形式 YYYY-MM-DD）
- 未入金内訳: 詳細情報（テキスト）
- Key: 重複防止用キー（一意識別子）
- 備考: 特記事項（テキスト）
```

**データ検証ルール**:
```
- 分類: 4種類の値のみ許可
- 金額: 正数のみ許可（負数は自動で絶対値化）
- メールアドレス: RFC準拠形式チェック
- 期日: 過去日付は警告表示（エラーではない）
```

---

# 🎨 **SECTION 4: UI/UX仕様書**

## 4.1 画面構成・ナビゲーション

### 🖥️ **メイン画面構成**
**レイアウト**: Single Page Application（SPA）
```
┌─ Header ────────────────────────────────┐
│ ロゴ | ユーザー名 | 通知 | ログアウト      │
├─ Sidebar ──┬─ Main Content ─────────────┤
│ ダッシュボード │                           │
│ タスク管理   │  [メインコンテンツエリア]    │
│ 顧客管理     │                           │
│ データ取込   │                           │
│ メール設定   │                           │
│ システム設定  │                           │
└─────────┴───────────────────────────┘
```

### 🧭 **ナビゲーション階層**
```
/dashboard - ダッシュボード
├ 統計サマリー表示
├ リアルタイムチャート
└ 最近のアクティビティ

/tasks - タスク管理（メイン画面）
├ 5ステップ進捗表示
├ 差異一覧（3表示モード切替）
├ 検索・フィルタ機能
└ 一括操作機能

/customers - 顧客管理
├ 顧客一覧
├ 顧客詳細・編集
└ リスクレベル管理

/invoices - 請求書管理
├ 請求書一覧
├ 新規作成・編集
├ ステータス管理
└ 支払状況追跡

/payments - 入金管理  
├ 入金一覧
├ 照合処理
├ 未照合入金表示
└ 手動マッチング

/data-import - データ取り込み
├ Excel アップロード
├ プレビュー・検証
└ 取り込み履歴

/email-settings - メール設定
├ SMTP設定
├ 接続テスト
└ 送信履歴

/email-templates - メールテンプレート
├ テンプレート管理
├ プレビュー
└ 変数管理

/auth - 認証関連
├ ログイン画面
├ ユーザー登録
├ パスワード変更
└ プロフィール管理

/settings - システム設定
├ 全般設定
├ ユーザー管理
├ システム設定
└ 通知設定
```

## 4.2 核心UI要素（心理的負担軽減重視）

### 📊 **5ステップ進捗表示**
**目的**: 処理の進捗を可視化し、心理的不安を軽減
**表示仕様**:
```
[1.検知] ──→ [2.メール送付] ──→ [3.連絡取得] ──→ [4.合意] ──→ [5.解決]
  20%           40%              60%           80%         100%

現在ステップ: 背景色ハイライト（青色）
完了ステップ: 背景色完了（緑色）
未完了ステップ: 背景色待機（グレー）

付加情報:
- 推定完了時間: "約1.5日後に完了予定"
- 次のアクション: "顧客からの返信を待機中"
- 進捗率: プログレスバー表示
```

### 🎛️ **3つの表示モード切り替え**
**列表モード（カード形式）**:
```
┌─ 差異カード1 ─┐  ┌─ 差異カード2 ─┐
│ 顧客名         │  │ 顧客名         │
│ 差異金額       │  │ 差異金額       │
│ 進捗バー       │  │ 進捗バー       │
│ [アクション]    │  │ [アクション]    │
└───────────┘  └───────────┘
用途: 概要把握・直感的操作
```

**ブロックモード（グリッド形式）**:
```
┌──────┬──────┬──────┐
│ 差異1   │ 差異2   │ 差異3   │
│ 詳細表示 │ 詳細表示 │ 詳細表示 │
├──────┼──────┼──────┤
│ 差異4   │ 差異5   │ 差異6   │
│ 詳細表示 │ 詳細表示 │ 詳細表示 │
└──────┴──────┴──────┘
用途: 一覧性・比較分析
```

**テーブルモード（表形式）**:
```
┌─────┬─────┬─────┬─────┬─────┐
│顧客名 │差異金額│ステータス│優先度│アクション│
├─────┼─────┼─────┼─────┼─────┤
│A社   │-50,000│メール送付│高   │[編集]  │
│B社   │+30,000│連絡取得 │中   │[削除]  │
└─────┴─────┴─────┴─────┴─────┘
用途: 詳細データ・一括編集
```

### 📧 **メール設定管理画面**
**目的**: SMTP送信設定・署名管理・接続テスト
**画面仕様**:
```
SMTP基本設定:
- サーバー: smtp.gmail.com
- ポート: 587 (STARTTLS) / 465 (SSL)
- 認証: ユーザー名・パスワード（アプリパスワード推奨）
- 暗号化: SSL/TLS自動判定

送信者情報:
- 送信者名: AR System
- 送信者メール: system@company.com
- デフォルトCC: manager@company.com
- デフォルトBCC: audit@company.com
- 署名: 12行テキストエリア（会社情報・連絡先）

テスト機能:
- 接続テスト: SMTP接続確認のみ
- テストメール送信: 実際のメール送信テスト
- 送信先指定: デフォルトは送信者メールアドレス

プロバイダープリセット:
- Gmail / Outlook / Yahoo 設定の一括適用
- ポート・暗号化の自動設定
```

### 📁 **Excel差異データ取り込み画面**
**目的**: 大量差異データの一括処理・AI自動判定
**画面仕様**:
```
ファイルアップロード:
- 対応形式: .xlsx, .xls, .csv
- ファイルサイズ制限: 50MB
- ドラッグ&ドロップ対応

必須項目チェック:
- 分類: 未入金/過入金/一部入金/複数請求
- 会社名: 顧客名（自動マッチング・新規作成）
- 金額: 差異金額（数値検証）
- to: 顧客メールアドレス（形式検証）

オプション項目:
- 決済期日: 支払期限
- 未入金内訳: 詳細情報
- Key: 重複防止用キー

処理フロー:
1. ファイル分析 → プレビュー表示
2. データ検証 → エラー表示・修正提案
3. 実行確認 → 一括処理実行
4. 結果表示 → 成功件数・エラー詳細

自動処理:
- 顧客レコード自動作成 (AUTO_001形式)
- AI確信度判定・介入レベル設定
- タスクレコード自動生成
- 重複データ自動スキップ
```

### 📈 **統計サマリー表示**
**リアルタイム統計バー**:
```
AI自律処理: 45件 | AI支援: 23件 | 人間対応: 12件 | 緊急: 3件
├─────────────────────────────────────────┤
│ ■■■■■■■■■■ 56% │ ■■■■■ 29% │ ■■■ 15% │ ■ 4% │
```

**効果測定表示**:
```
本日の成果:
- 自動化率: 72% ↗ (目標70%達成)
- 平均処理時間: 1.8日 ↗ (目標2日クリア)
- 解決済み件数: 23件 ↗
```

## 4.3 インタラクション・操作方式

### 🖱️ **直感的操作インターフェース**
**差異レコード操作**:
- **クリック**: 詳細表示・編集モードへ遷移
- **ダブルクリック**: 即座編集開始
- **右クリック**: コンテキストメニュー表示
  - メール送信
  - ステータス変更
  - 担当者変更
  - 削除
- **ドラッグ&ドロップ**: ステータス列間移動（かんばん方式）

**一括操作機能**:
- **Shift+クリック**: 範囲選択
- **Ctrl+クリック**: 複数選択
- **全選択チェックボックス**: 一括選択
- **一括アクションバー**: 選択済みレコードに対する一括操作

### ⚡ **リアルタイム更新**
**自動画面更新**:
```
- 新規差異検知: 5秒以内に画面反映 + 通知表示
- ステータス変更: 即座に進捗バー更新
- メール送信完了: リアルタイムで送信状態更新
- 顧客返信受信: 自動でステップ3へ遷移

通知方式:
- トースト通知: 重要な状態変更
- バッジ表示: 未読件数
- 色変化: 新規・更新項目のハイライト
```

---

# ⚙️ **SECTION 5: 技術制約仕様書**

## 5.1 技術スタック制約

### 💻 **必須技術スタック**
**フロントエンド**:
```
- React 18+ (必須)
- TypeScript 5+ (必須)
- Tailwind CSS 3+ (必須)
- React Query / TanStack Query (データフェッチング)
- React Hook Form (フォーム管理)
- Chart.js (データ可視化)
```

**バックエンド**:
```
- Node.js 18+ (必須)
- Express.js 4.18+ (必須)
- TypeScript 5+ (必須)
- Prisma ORM 5.8+ (必須)
- JWT (認証)
- Nodemailer (メール送信)
```

**データベース**:
```
- 開発環境: SQLite (ファイルベース)
- 本番環境: PostgreSQL 14+ (推奨)
- ORM: Prisma (必須)
```

### 🚀 **推奨技術・ツール**
- **状態管理**: React Context + useReducer
- **バリデーション**: Yup スキーマ
- **リアルタイム**: Socket.IO (オプション)
- **ファイルアップロード**: Multer
- **日付処理**: date-fns
- **CSV/Excel処理**: xlsx ライブラリ

## 5.2 非機能要件

### ⚡ **パフォーマンス要件**
```
画面表示応答時間:
- 初回ログイン: 3秒以内
- 画面遷移: 1秒以内
- データ更新: 0.5秒以内

API応答時間:
- 簡単な検索: 0.5秒以内
- 複雑な分析: 2秒以内
- Excel取り込み: 1000件/分以上

スケーラビリティ:
- 同時利用者: 50人まで
- データ件数: 100,000件まで
- 差異処理: 1000件/日まで
```

### 📧 **メール処理要件**
```
メール送信制限:
- 時間あたり送信制限: 50通/時間（設定可能）
- 日次送信制限: 200通/日（設定可能）
- 送信間隔: 30秒間隔（設定可能）
- 同一差異連絡間隔: 72時間必須

SMTP接続要件:
- 対応プロトコル: SMTP/STARTTLS/SSL
- 対応ポート: 25/587/465
- 認証方式: PLAIN/LOGIN/OAuth2対応
- タイムアウト: 30秒

メール品質保証:
- 配信確認: Delivery Status Notification対応
- エラーハンドリング: 自動リトライ3回
- ログ保持: 送信結果完全記録
- テンプレート検証: 変数置換エラー防止
```

### 🔒 **セキュリティ要件**
```
通信セキュリティ:
- HTTPS通信必須
- CORS設定適切実装
- XSS・CSRF対策必須

認証・認可:
- JWT認証（7日間有効）
- ロールベースアクセス制御
- セッションタイムアウト（24時間）

データ保護:
- 個人情報暗号化保存
- SQLインジェクション対策
- ファイルアップロード制限（10MB）
- アクセスログ記録
```

### 📊 **可用性・運用要件**
```
システム稼働:
- 稼働率: 99%以上
- ダウンタイム: 月4時間以内
- 自動復旧機能

バックアップ・復旧:
- データベース日次バックアップ
- 設定ファイル週次バックアップ
- 災害時復旧手順書

ログ・監視:
- アプリケーションログ: 1年間保持
- アクセスログ: 6ヶ月保持
- エラー監視: 自動アラート機能
```

## 5.3 運用制約・制限事項

### 🌐 **環境制約**
**開発環境**:
```
- OS: macOS / Windows / Linux対応
- Node.js: v18以上必須
- ブラウザ: Chrome/Firefox/Safari/Edge 最新2バージョン
- 開発サーバー: localhost:3000 (frontend), localhost:3001 (backend)
```

**本番環境**:
```
- コンテナ: Docker対応必須
- プロキシ: Nginx推奨
- データベース: PostgreSQL専用
- ファイルストレージ: ローカル or S3互換
```

### 📋 **データ制約・保持期間**
```
データ保持ルール:
- 顧客データ: 契約終了後5年間
- 差異データ: 解決後5年間
- メールログ: 送信後1年間
- アクセスログ: 6ヶ月間
- システムログ: 1年間

データサイズ制限:
- 単一Excelファイル: 10MB以内
- 一括取り込み: 5,000件/回以内
- メール添付: 5MB以内
- データベース: 1GB以内（目安）
```

### ⚖️ **法的・コンプライアンス制約**
```
個人情報保護:
- 個人情報保護法完全準拠
- GDPR該当時は追加対応
- データ削除権対応

会計・監査:
- 監査証跡完全保持
- データ改ざん防止措置
- 定期的な内部監査対応

メール送信:
- 特定電子メール法準拠
- オプトアウト機能実装
- 送信頻度制限（1日3通まで/顧客）
```

---

# 🎯 **使用指示・実行方法**

## ✅ **この仕様書でのシステム自動生成手順**

### Step 1: 仕様書提示
```
「Ver4.0_真のゼロベース仕様書_業務要件抽出版.mdに基づいて、
売掛金管理AIエージェントシステムを完全自動構築してください。

重要: 実装コードを参照せず、この仕様書のみでシステム生成してください。
研究観点（AI自律処理70%・心理的負担軽減）を最重視してください。」
```

### Step 2: 段階的構築指示
```
優先順位:
1. データベース設計・構築（Section 3準拠）
   - 6エンティティ完全実装（Customer/PaymentDiscrepancy/EmailLog/SystemConfig/EmailTemplate/ActivityLog）
   - リレーション・インデックス設定
   - サンプルデータ・シードスクリプト作成

2. Backend API実装（Section 2準拠）
   - 差異管理API（CRUD・検索・統計）
   - メール管理API（生成・送信・テンプレート管理・設定）
   - データ取り込みAPI（Excel分析・処理・検証）
   - 認証・権限管理API

3. Frontend UI実装（Section 4準拠）
   - 5ステップ進捗管理画面
   - 3表示モード切り替え機能
   - メール設定管理画面（SMTP・署名・テスト）
   - Excel取り込み画面（分析・プレビュー・実行）

4. 研究効果測定機能（Section 1準拠）
   - AI自律処理率リアルタイム計測
   - 心理的負担軽減効果可視化
   - 処理時間短縮効果測定

5. 動作確認・品質保証（Section 5準拠）
   - 全機能統合テスト
   - メール送信テスト・SMTP接続確認
   - Excel取り込みテスト・大量データ処理
```

### Step 3: 成功確認指標
```
✅ AI自律処理70%達成確認
✅ 5ステップ進捗表示正常動作
✅ 3表示モード切り替え機能
✅ Excel取り込み・メール送信機能
✅ SMTP設定・テンプレート管理機能
✅ レコード編集・削除・一括操作機能
✅ リアルタイム統計・ダッシュボード機能
✅ 心理的負担軽減効果測定準備
```

## 🚀 **期待される成果**

**✅ 完全ソースコード参照不要**: この仕様書のみで同等システム生成可能
**✅ 研究価値実証**: AI自律処理・心理的負担軽減の定量測定可能
**✅ 業務効率化**: 処理時間80%短縮・作業負荷70%削減達成
**✅ 品質保証**: 標準化・一貫性・監査対応完備

---

**💡 結論**: この真のゼロベース仕様書により、実装詳細に依存しない純粋な業務要件から直接システム生成が可能になりました。研究観点を重視し、確実に動作する高品質システムを構築できます。